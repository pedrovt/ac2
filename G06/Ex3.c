// --------------------------------
// Gui√£o 6, Ex.3
// Arquitectura de Computadores II
// Pedro Teixeira, 84715, MIECT
// --------------------------------

# include <detpic32.h>
# include "../Utils/utils.h"

# define  numSamples 4

// Interrupt Handler
void _int_(27) isr_adc(void) {
  // Debug
  // printf("\nEntering Interrupt Handler for ADC\n");

  // Read conversion result (ADC1BUF0 value) and print it
  printInt(ADC1BUF0, 16 | 3 << 16);

  // Start conversion
  AD1CON1bits.ASAM = 1;

  // Reset AD1IF
  IFS1bits.AD1IF = 0;

  // Set RB6
  LATBbits.LATB6 = 1;
}

int main(void) {
  // Configure RB6 as digital output port
  TRISBbits.TRISB6 = 0;

  // Configure port RB4 as analog input
  TRISBbits.TRISB4  = 1;   // RB4 digital output disconnected
  AD1PCFGbits.PCFG4 = 0;   // RB4 configured as analog input (AN4)

  // ADC Desired input analog channel (0 to 15)
  AD1CHSbits.CH0SA  = 4;

  configADC(numSamples);

  // Interrupt System
  // Step 1. Set Priority Level of the ADC Interrupts: value between 1 and 6 (7
  // is max priority and should NOT be used and 0 means no interrupts are accepted
  IPC6bits.AD1IP = 2;

  // Step 2. Authorize the interrupts generated by the ADC
  IEC1bits.AD1IE = 1;

  // Step 3. Reset ADC interrupt flag
  IFS1bits.AD1IF = 0;

  // Step 4. Global enable of the interrupt system
  EnableInterrupts();

  // Start conversion
  AD1CON1bits.ASAM = 1;

  while (1) {
    // Reset RB6
    LATBbits.LATB6 = 0;
  }

  return 1;
}
